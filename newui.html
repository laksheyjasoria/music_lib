<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="logonew.png" />
    <title>Nozzify</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        background-color: #121212;
        color: white;
        padding: 20px;
      }

      input,
      button {
        padding: 10px;
        font-size: 16px;
        margin: 5px;
        border-radius: 5px;
      }

      input {
        width: 60%;
      }

      button {
        cursor: pointer;
        background-color: #ff0000;
        color: white;
        border: none;
        transition: 0.3s;
      }

      button:hover {
        background-color: #cc0000;
      }

      .video-container {
        margin-top: 20px;
      }

      img {
        width: 300px;
        border-radius: 10px;
        margin-top: 10px;
      }

      .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
        gap: 10px;
      }

      .progress-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
      }

      .progress-bar {
        width: 60%;
      }

      .time {
        font-size: 14px;
      }

      .error {
        color: red;
        margin-top: 20px;
      }

      .carousel,
      .trending,
      .most-played,
      .favorites-list {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        padding: 10px;
        margin-top: 20px;
        scrollbar-width: none;
      }

      .carousel-item,
      .trending-item,
      .most-played-item,
      .favorite-item {
        cursor: pointer;
        width: 120px;
        flex-shrink: 0;
        text-align: center;
        background: #333;
        padding: 5px;
        border-radius: 8px;
        color: white;
      }

      .carousel-item img,
      .trending-item img,
      .most-played-item img,
      .favorite-item img {
        width: 100px;
        border-radius: 8px;
      }

      .favorite-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        margin-left: 10px;
      }

      .heart-icon {
        width: 32px;
        height: 32px;
        fill: transparent;
        stroke: #ff0000;
        stroke-width: 2px;
        transition: all 0.3s;
      }

      .heart-icon.favorited {
        fill: #ff0000;
        stroke: #ff0000;
        filter: drop-shadow(0 0 2px #ff0000);
      }

      .sleep-timer-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #ff4444;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        z-index: 1000;
      }

      .timer-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #333;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        z-index: 1001;
        color: white;
        width: 400px;
      }

      .timer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .close-btn {
        cursor: pointer;
        font-size: 24px;
        padding: 0 8px;
        transition: 0.3s;
      }

      .close-btn:hover {
        color: #ff4444;
      }

      .time-selector {
        display: flex;
        gap: 10px;
        height: 200px;
        overflow: hidden;
      }

      .time-column {
        flex: 1;
        overflow-y: auto;
        scroll-snap-type: y mandatory;
        height: 100%;
      }

      .time-item {
        scroll-snap-align: center;
        padding: 12px 0;
        text-align: center;
        font-size: 18px;
        color: #888;
        transition: all 0.2s;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .time-item.selected {
        color: white;
        font-size: 24px;
        font-weight: bold;
      }

      .countdown-display {
        font-size: 32px;
        margin: 20px 0;
        letter-spacing: 2px;
      }

      .active-timer {
        display: none;
        text-align: center;
      }

      .favorites-section {
        display: none;
        margin-top: 20px;
      }

      .favorites-toggle {
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: #ff4444;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        z-index: 1000;
      }

      .notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #ff4444;
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        display: none;
        z-index: 1002;
      }
    </style>
  </head>
  <body>
    <h1>Nozzify</h1>
    <input type="text" id="searchQuery" placeholder="Enter song name..." />
    <button onclick="searchMusic()">Search</button>
    <div id="videoResult" class="video-container"></div>
    <div class="progress-container">
      <span id="currentTime" class="time">0:00</span>
      <input type="range" id="progressBar" class="progress-bar" min="0" max="100" value="0" />
      <span id="totalDuration" class="time">0:00</span>
      <button class="favorite-btn" onclick="toggleFavorite()">
        <svg class="heart-icon" viewBox="0 0 24 24">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
        </svg>
      </button>
    </div>
    <div class="controls">
      <button onclick="shuffleQueue()">üîÄ</button>
      <button onclick="prevSong()">‚èÆÔ∏è</button>
      <button id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂Ô∏è</button>
      <button onclick="nextSong()">‚è≠Ô∏è</button>
      <button onclick="toggleRepeat()">üîÅ</button>
    </div>
    <div class="sleep-timer-btn" onclick="showTimerPopup()">‚è± Sleep Timer</div>
    <div class="timer-popup" id="timerPopup">
      <div class="timer-header">
        <h3>Set Sleep Timer</h3>
        <div class="close-btn" onclick="hideTimerPopup()">√ó</div>
      </div>
      <div class="time-selector">
        <div class="time-column" id="hoursColumn">
          <div class="time-item">0h</div>
          <div class="time-item">1h</div>
          <div class="time-item">2h</div>
          <div class="time-item">3h</div>
          <div class="time-item">4h</div>
        </div>
        <div class="time-column" id="minutesColumn"></div>
        <div class="time-column" id="secondsColumn"></div>
      </div>
      <div class="active-timer" id="activeTimer">
        <div class="countdown-display" id="countdownDisplay"></div>
        <button onclick="resetSleepTimer()">Cancel Timer</button>
      </div>
      <div style="margin-top: 20px;">
        <button onclick="setSleepTimer()">Apply</button>
        <button onclick="resetSleepTimer()">Reset</button>
      </div>
    </div>
    <button class="favorites-toggle" id="favoritesToggleBtn" onclick="toggleFavorites()">‚ù§Ô∏è Show Favorites</button>
    <div class="favorites-section" id="favoritesSection">
      <h2>Your Favorite Songs</h2>
      <div id="favoritesList" class="favorites-list"></div>
    </div>
    <audio id="audioPlayer" ontimeupdate="updateProgress()" onended="nextSong()"></audio>
    <h2>Related Searches</h2>
    <div id="carouselContainer" class="carousel"></div>
    <h2>Trending Songs</h2>
    <div id="trendingContainer" class="trending"></div>
    <h2>Top 50 Most Played Songs</h2>
    <div id="mostPlayedContainer" class="most-played"></div>
    <p id="errorMessage" class="error"></p>
    <div class="notification" id="notification"></div>
    <script>
      const BACKEND_URL = "https://musiclib-production.up.railway.app";
      const audioPlayer = document.getElementById("audioPlayer");
      const playPauseBtn = document.getElementById("playPauseBtn");
      const favToggleBtn = document.getElementById("favoritesToggleBtn");
      
      let isRepeating = false;
      let sleepTimer = null;
      let countdownInterval = null;
      let endTime = null;
      let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      let selectedHours = 0;
      let selectedMinutes = 0;
      let selectedSeconds = 0;
      let currentSong = null;

      function initializeTimeWheels() {
        const minutesColumn = document.getElementById("minutesColumn");
        const secondsColumn = document.getElementById("secondsColumn");
        
        minutesColumn.innerHTML = '';
        for (let i = 0; i < 60; i++) {
          const div = document.createElement("div");
          div.className = "time-item";
          div.textContent = `${i}m`;
          minutesColumn.appendChild(div);
        }
        
        secondsColumn.innerHTML = '';
        for (let i = 0; i < 60; i++) {
          const div = document.createElement("div");
          div.className = "time-item";
          div.textContent = `${i}s`;
          secondsColumn.appendChild(div);
        }
      }

      function setupTimeWheels() {
        const hoursColumn = document.getElementById("hoursColumn");
        const minutesColumn = document.getElementById("minutesColumn");
        const secondsColumn = document.getElementById("secondsColumn");
        const itemHeight = 40;

        hoursColumn.scrollTop = selectedHours * itemHeight;
        minutesColumn.scrollTop = selectedMinutes * itemHeight;
        secondsColumn.scrollTop = selectedSeconds * itemHeight;

        function handleScroll(column, type) {
          const mid = column.offsetHeight / 2;
          Array.from(column.children).forEach((item, index) => {
            const itemTop = item.offsetTop - column.scrollTop;
            if (Math.abs(itemTop - mid) < itemHeight) {
              item.classList.add("selected");
              switch(type) {
                case 'hours': selectedHours = index; break;
                case 'minutes': selectedMinutes = index; break;
                case 'seconds': selectedSeconds = index; break;
              }
            } else {
              item.classList.remove("selected");
            }
          });
        }

        hoursColumn.addEventListener("scroll", () => handleScroll(hoursColumn, 'hours'));
        minutesColumn.addEventListener("scroll", () => handleScroll(minutesColumn, 'minutes'));
        secondsColumn.addEventListener("scroll", () => handleScroll(secondsColumn, 'seconds'));
      }

      function updateCountdownDisplay() {
        if (!endTime) return;
        
        const remaining = endTime - Date.now();
        if (remaining <= 0) {
          resetSleepTimer();
          audioPlayer.pause();
          audioPlayer.currentTime = 0;
          showNotification("Sleep timer ended playback");
          return;
        }

        const hours = Math.floor(remaining / 3600000);
        const minutes = Math.floor((remaining % 3600000) / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        document.getElementById("countdownDisplay").textContent = 
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }

      function setSleepTimer() {
        const totalMs = (selectedHours * 3600 + selectedMinutes * 60 + selectedSeconds) * 1000;
        if (totalMs > 0) {
          endTime = Date.now() + totalMs;
          
          document.querySelector(".time-selector").style.display = "none";
          document.getElementById("activeTimer").style.display = "block";
          
          countdownInterval = setInterval(updateCountdownDisplay, 1000);
          updateCountdownDisplay();
          showNotification("Sleep timer set");
        }
        hideTimerPopup();
      }

      function resetSleepTimer() {
        if (countdownInterval) clearInterval(countdownInterval);
        if (sleepTimer) clearTimeout(sleepTimer);
        
        endTime = null;
        countdownInterval = null;
        sleepTimer = null;
        
        document.querySelector(".time-selector").style.display = "flex";
        document.getElementById("activeTimer").style.display = "none";
        hideTimerPopup();
        showNotification("Timer cancelled");
      }

      function showTimerPopup() {
        document.getElementById("timerPopup").style.display = "block";
        setupTimeWheels();
        if (endTime) {
          document.querySelector(".time-selector").style.display = "none";
          document.getElementById("activeTimer").style.display = "block";
        }
      }

      function hideTimerPopup() {
        document.getElementById("timerPopup").style.display = "none";
      }

      function togglePlayPause() {
        if (audioPlayer.paused) {
          audioPlayer.play();
          playPauseBtn.textContent = "‚è∏Ô∏è";
        } else {
          audioPlayer.pause();
          playPauseBtn.textContent = "‚ñ∂Ô∏è";
        }
      }

      function updateProgress() {
        const progressBar = document.getElementById("progressBar");
        const currentTime = document.getElementById("currentTime");
        const totalDuration = document.getElementById("totalDuration");
        
        progressBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        currentTime.textContent = formatTime(audioPlayer.currentTime);
        totalDuration.textContent = formatTime(audioPlayer.duration);
      }

      document.getElementById("progressBar").addEventListener("input", function() {
        audioPlayer.currentTime = (this.value / 100) * audioPlayer.duration;
      });

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
      }

      function getQueue() {
        return JSON.parse(sessionStorage.getItem("queue")) || [];
      }

      function saveQueue(queue) {
        sessionStorage.setItem("queue", JSON.stringify(queue));
      }

      function fetchAudio(videoId, title, thumbnail) {
        fetch(`${BACKEND_URL}/get_audio?videoId=${videoId}`)
          .then(response => response.json())
          .then(data => {
            audioPlayer.src = data.audioUrl;
            audioPlayer.play();
            currentSong = { videoId, title, thumbnail };
            updateMediaSession(title, thumbnail);
            updateNowPlaying(title, thumbnail);
            updateFavoriteButton();
          })
          .catch(() => showError("Failed to load audio"));
      }

      function updateMediaSession(title, thumbnail) {
        if ("mediaSession" in navigator) {
          navigator.mediaSession.metadata = new MediaMetadata({
            title,
            artwork: [{ src: thumbnail, sizes: "512x512" }]
          });
        }
      }

      function updateNowPlaying(title, thumbnail) {
        document.getElementById("videoResult").innerHTML = `
          <h2>${title}</h2>
          <img src="${thumbnail}" alt="${title}">
          <p>üéµ Now Playing</p>`;
      }

      function searchMusic() {
        const query = document.getElementById("searchQuery").value;
        if (!query) return;
        
        fetch(`${BACKEND_URL}/search_music?query=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(data => {
            saveQueue(data.search_results);
            sessionStorage.setItem("currentIndex", 0);
            const firstResult = data.search_results[0];
            fetchAudio(firstResult.videoId, firstResult.title, firstResult.thumbnail);
            refreshCarousel(data.search_results);
          })
          .catch(() => showError("Search failed"));
      }

      function prevSong() {
        let currentIndex = parseInt(sessionStorage.getItem("currentIndex"), 10);
        if (currentIndex > 0) currentIndex--;
        sessionStorage.setItem("currentIndex", currentIndex);
        const song = getQueue()[currentIndex];
        fetchAudio(song.videoId, song.title, song.thumbnail);
      }

      function nextSong() {
        let currentIndex = parseInt(sessionStorage.getItem("currentIndex"), 10);
        const queue = getQueue();
        
        if (currentIndex < queue.length - 1) {
          currentIndex++;
        } else if (isRepeating) {
          currentIndex = 0;
        }
        
        sessionStorage.setItem("currentIndex", currentIndex);
        const song = queue[currentIndex];
        fetchAudio(song.videoId, song.title, song.thumbnail);
      }

      function shuffleQueue() {
        const queue = getQueue();
        for (let i = queue.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [queue[i], queue[j]] = [queue[j], queue[i]];
        }
        saveQueue(queue);
        refreshCarousel(queue);
      }

      function toggleRepeat() {
        isRepeating = !isRepeating;
        document.querySelector("button[onclick='toggleRepeat()']").style.backgroundColor = isRepeating ? "#00ff00" : "#ff0000";
      }

      function refreshCarousel(results) {
        const carousel = document.getElementById("carouselContainer");
        carousel.innerHTML = "";
        
        results.slice(1).forEach(song => {
          const item = document.createElement("div");
          item.className = "carousel-item";
          item.innerHTML = `
            <img src="${song.thumbnail}">
            <p>${song.title}</p>`;
          item.onclick = () => fetchAudio(song.videoId, song.title, song.thumbnail);
          carousel.appendChild(item);
        });
      }

      function populateSection(containerId, items) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        
        items.forEach(song => {
          const item = document.createElement("div");
          item.className = containerId.replace("Container", "-item");
          item.innerHTML = `
            <img src="${song.thumbnail}">
            <p>${song.title}</p>`;
          item.onclick = () => fetchAudio(song.videoId, song.title, song.thumbnail);
          container.appendChild(item);
        });
      }

      async function fetchTrendingSongs() {
        try {
          const response = await fetch(`${BACKEND_URL}/get_trending_music`);
          const data = await response.json();
          populateSection("trendingContainer", data.trending_music);
        } catch {
          showError("Failed to load trending");
        }
      }

      async function fetchMostPlayedSongs() {
        try {
          const response = await fetch(`${BACKEND_URL}/get_most_played_songs`);
          const data = await response.json();
          populateSection("mostPlayedContainer", data.most_played_songs);
        } catch {
          showError("Failed to load most played");
        }
      }

      function toggleFavorite() {
        if (!currentSong) return;
        
        const index = favorites.findIndex(f => f.videoId === currentSong.videoId);
        if (index === -1) {
          favorites.push(currentSong);
          showNotification("‚úÖ Added to Favorites");
        } else {
          favorites.splice(index, 1);
          showNotification("üóëÔ∏è Removed from Favorites");
        }
        
        localStorage.setItem("favorites", JSON.stringify(favorites));
        updateFavoriteButton();
        refreshFavoritesList();
      }

      function updateFavoriteButton() {
        const heartIcon = document.querySelector(".heart-icon");
        const isFavorited = currentSong && favorites.some(f => f.videoId === currentSong.videoId);
        heartIcon.classList.toggle("favorited", isFavorited);
      }

      function refreshFavoritesList() {
        const container = document.getElementById("favoritesList");
        container.innerHTML = "";
        
        favorites.forEach(song => {
          const item = document.createElement("div");
          item.className = "favorite-item";
          item.innerHTML = `
            <img src="${song.thumbnail}" alt="${song.title}">
            <p>${song.title}</p>`;
            
          item.onclick = () => {
            const queue = getQueue();
            const index = queue.findIndex(track => track.videoId === song.videoId);
            
            if (index === -1) {
              queue.unshift(song);
              saveQueue(queue);
              sessionStorage.setItem("currentIndex", 0);
            } else {
              sessionStorage.setItem("currentIndex", index);
            }
            
            fetchAudio(song.videoId, song.title, song.thumbnail);
          };
          
          container.appendChild(item);
        });
      }

      function toggleFavorites() {
        const section = document.getElementById("favoritesSection");
        const isVisible = section.style.display === "block";
        
        section.style.display = isVisible ? "none" : "block";
        favToggleBtn.textContent = isVisible ? "‚ù§Ô∏è Show Favorites" : "üíî Hide Favorites";
        
        if (!isVisible) refreshFavoritesList();
      }

      function showNotification(message) {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.style.display = "block";
        setTimeout(() => notification.style.display = "none", 3000);
      }

      function showError(message) {
        const errorElement = document.getElementById("errorMessage");
        errorElement.textContent = message;
        setTimeout(() => errorElement.textContent = "", 5000);
      }

      document.addEventListener("keydown", (event) => {
        if (document.activeElement.tagName === "INPUT") return;
        
        switch(event.key) {
          case " ":
            event.preventDefault();
            togglePlayPause();
            break;
          case "ArrowLeft":
            prevSong();
            break;
          case "ArrowRight":
            nextSong();
            break;
          case "s":
            shuffleQueue();
            break;
          case "r":
            toggleRepeat();
            break;
        }
      });

      window.onload = () => {
        initializeTimeWheels();
        fetchTrendingSongs();
        fetchMostPlayedSongs();
        setInterval(fetchMostPlayedSongs, 30000);
        refreshFavoritesList();
        
        const queue = getQueue();
        if (queue.length) {
          const index = parseInt(sessionStorage.getItem("currentIndex"), 10) || 0;
          const song = queue[index];
          fetchAudio(song.videoId, song.title, song.thumbnail);
          refreshCarousel(queue);
        }
      };
    </script>
  </body>
</html>
